<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hdsx.lwgl.statanalysis.mapper184.BlockYhMapper">
    <resultMap id="BaseResultMap" type="com.hdsx.lwgl.statanalysis.entity.T_BLOCK_YH_CURRENT">
        <id column="ID" property="id" jdbcType="VARCHAR" />
        <result column="ROADCODE" property="roadcode" jdbcType="VARCHAR" />
        <result column="ROADNAME" property="roadname" jdbcType="VARCHAR" />
        <result column="SEGMENT_CODE" property="segmentCode" jdbcType="VARCHAR" />
        <result column="SEGMENT_NAME" property="segmentName" jdbcType="VARCHAR" />
        <result column="BLOCK_REASON" property="blockReason" jdbcType="VARCHAR" />
        <result column="DETECT_TIME" property="detectTime" jdbcType="TIMESTAMP" />
        <result column="ESTIMATE_TIME" property="estimateTime" jdbcType="TIMESTAMP" />
        <result column="RESUME_TIME" property="resumeTime" jdbcType="TIMESTAMP" />
        <result column="ROADSTART" property="roadstart" jdbcType="DECIMAL" />
        <result column="ROADEND" property="roadend" jdbcType="DECIMAL" />
        <result column="DIRECTION" property="direction" jdbcType="DECIMAL" />
        <result column="SCENE_DESC" property="sceneDesc" jdbcType="VARCHAR" />
        <result column="REPORT_UNIT" property="reportUnit" jdbcType="VARCHAR" />
        <result column="REPORT_USER" property="reportUser" jdbcType="VARCHAR" />
        <result column="REPORT_USER_PHONE" property="reportUserPhone" jdbcType="VARCHAR" />
        <result column="DISTCODE" property="distcode" jdbcType="VARCHAR" />
        <result column="BLOCK_MILEAGE" property="blockMileage" jdbcType="DECIMAL" />
        <result column="SUM_WOUNDED" property="sumWounded" jdbcType="DECIMAL" />
        <result column="SUM_DEAD" property="sumDead" jdbcType="DECIMAL" />
        <result column="SUM_DESTORY" property="sumDestory" jdbcType="DECIMAL" />
        <result column="SUM_DETAIN" property="sumDetain" jdbcType="DECIMAL" />
        <result column="CLOSEABLE" property="closeable" jdbcType="DECIMAL" />
        <result column="SYS_OTIME" property="sysOtime" jdbcType="TIMESTAMP" />
        <result column="SOURCE" property="source" jdbcType="VARCHAR" />
        <result column="MEASURES" property="measures" jdbcType="VARCHAR" />
        <result column="CENTER_POINT" property="centerPoint" jdbcType="VARCHAR" />
        <result column="BLOCK_REASON_ID" property="blockReasonId" jdbcType="VARCHAR" />
        <result column="INTERRUPT" property="interrupt" jdbcType="DECIMAL" />
        <result column="HAPPEN_TIME" property="happenTime" jdbcType="TIMESTAMP" />
        <result column="THROUGH_EFFECT" property="throughEffect" jdbcType="DECIMAL" />
        <result column="BLOCK_TYPE" property="block_type" jdbcType="DECIMAL" />
        <result column="ROADRANGTEXT" property="roadRangText" jdbcType="VARCHAR" />
        <result column="DIRECTIONTEXT" property="directiontext" jdbcType="VARCHAR" />

    </resultMap>

    <sql id="Base_Column_List" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        ID, ROADCODE, ROADNAME, SEGMENT_CODE, SEGMENT_NAME, BLOCK_REASON, DETECT_TIME, ESTIMATE_TIME,
        RESUME_TIME, ROADSTART, ROADEND, DIRECTION, SCENE_DESC, REPORT_UNIT, REPORT_USER,
        REPORT_USER_PHONE, DISTCODE, SUM_WOUNDED, SUM_DEAD, SUM_DESTORY, SUM_DETAIN,
        CLOSEABLE, SYS_OTIME, SOURCE, MEASURES, CENTER_POINT, BLOCK_REASON_ID, INTERRUPT,
        HAPPEN_TIME, THROUGH_EFFECT, BLOCK_TYPE, 'K' || floor(roadstart) || '+' ||
        (roadstart - floor(roadstart)) * 1000 || ' 到 ' || 'K' ||
        floor(roadend) || '+' || (roadend - floor(roadend)) * 1000 as ROADRANGTEXT,
        abs(roadend - roadstart) as BLOCK_MILEAGE,decode(direction,1,'上行',2,'下行','双向') as DIRECTIONTEXT
    </sql>

    <sql id="leftTable">
        SELECT rownum rn FROM DUAL CONNECT BY rownum <![CDATA[ <= ]]> 12
    </sql>

    <sql id="queryWhere">
        <if test="closeable != null and closeable != -1">
            and closeable = #{closeable,jdbcType=DECIMAL}
        </if>
    </sql>

    <select id="getDateList" parameterType="hashmap" resultType="int">
        <include refid="leftTable"/>
    </select>

    <sql id="rightTable" >
        select to_number(to_char(t.sys_otime, 'mm')) as rn, count(*) as cnt
        from V_BLOCK_YH_ALL t
        where to_char(t.sys_otime, 'yyyy') = #{year,jdbcType=VARCHAR}
        <include refid="queryWhere"/>
        group by to_number(to_char(t.sys_otime, 'mm'))
    </sql>

    <select id="statMaintainTimesPerMonth" parameterType="hashmap" resultType="int" >
        select
          nvl(b.cnt, 0)
        from (<include refid="leftTable"/>) a
        left join (<include refid="rightTable"/>) b
        on a.rn = b.rn
        order by a.rn
    </select>

    <sql id="rightTableMile" >
        select to_number(to_char(t.sys_otime, 'mm')) as rn, sum(abs(t.roadstart - t.roadend)) as mile
        from V_BLOCK_YH_ALL t
        where to_char(t.sys_otime, 'yyyy') = #{year,jdbcType=VARCHAR}
        <include refid="queryWhere"/>
        group by to_number(to_char(t.sys_otime, 'mm'))
    </sql>

    <select id="statMaintainMilePerMonth" parameterType="hashmap" resultType="int" >
        select
        nvl(b.mile, 0)
        from (<include refid="leftTable"/>) a
        left join (<include refid="rightTableMile"/>) b
        on a.rn = b.rn
        order by a.rn
    </select>

    <select id="selectRoad" parameterType="java.util.Map" resultMap="BaseResultMap">
        select distinct t.roadcode,t.direction from T_BLOCK_YH_CURRENT t where t.direction <![CDATA[ <> ]]> 3 AND CENTER_POINT IS NOT NULL
    </select>

    <select id="selectList" parameterType="java.util.Map" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />
        from T_BLOCK_YH_CURRENT
        where 1=1
        AND ROADCODE = #{roadcode,jdbcType=VARCHAR}
        AND (DIRECTION = #{direction,jdbcType=DECIMAL} OR DIRECTION = 3)
        AND CENTER_POINT IS NOT NULL
        ORDER  by center_point
    </select>

</mapper>
